---
title: "Multiple Regression Assignment"
author: "MATH 456 - Spring 2018"
output: pdf_document
---

```{r, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
library(ggplot2)
library(pander)
library(dplyr)

fev <- read.delim("C:/GitHub/website/static/data/Lung_081217.txt", sep="\t", header=TRUE)
names(fev) <- tolower(names(fev))
ncb <- read.csv("C:/GitHub/website/static/data/NCbirths.csv", header=TRUE)
names(ncb) <- tolower(names(ncb))
hiv <- read.delim("C:/GitHub/website/static/data/PARHIV_081217.txt", sep="\t", header=TRUE)
names(hiv) <- tolower(names(hiv))
dep <- read.delim("C:/GitHub/website/static/data/depress_081217.txt", sep="\t", header=TRUE)
names(dep) <- tolower(names(dep))
```

## Using the NCbirths data set

**1. Model birthweight using mothers age, smoking habit, and number of visits.**

```{r}
mod1 <- lm(weight ~ mage + habit + visits, data=ncb)
pander(summary(mod1))
```

**2. Calculate and interpret a 95% prediction interval for a 30-year old smoking mother with 16 visits to the doctor during her pregnancy.**

```{r}
newdata <- data.frame(mage=30, habit='smoker', visits=16)
predict(mod1, newdata, interval="prediction")
```

The average 30 year old smoking mother who visits the doctor 16 times during her prengancny is predicted to have a baby who weighs 7.1 (4.2, 10.0) pounds. 


**3. Does smoking habit affect the relationship between age and birth weight?**

We should examine this question graphically before fitting a model. 

```{r, fig.align='center', fig.height=3, fig.width=6}
ggplot(ncb, aes(x=mage, y=weight, col=habit)) + 
  geom_point() + geom_smooth(se=FALSE) + theme_bw()
```

The overall pattern between mothers age and baby weight is similar for smokers versus non-smokers. 
Smokers overall seem to have a lower average weight (blue line is lower), and baby weight slightly
increases with the mothers age, until around 30, then declines. Baby weights from non-smoking mothers
don't decline at 30 like for smokers. So smoking habit may affect the relationship between age
and birthweight. 

```{r}
mod1.intx <- lm(weight ~ habit + mage + mage*habit, data=ncb)
pander(summary(mod1.intx))
```

The interaction term between smoking and mothers age is non-significant at the 0.5 level, but with a p-value of 0.09 we we are seeing statistical confirmation of what we saw visually. There is a difference, 
but it is not a strong one and may not be clinically relevant. 

\newpage

## Textbook problems

**7.5) From the depression data set described in Table 3.4, predict the reported level of depression as given by CESD, using INCOME, SEX, and AGE as independent variables. Analyze the residuals and decide whether or not it is reasonable to assume that they follow a normal distribution.**


```{r}
dep.mod <- lm(cesd ~ income + sex + age, data=dep)
par(mfrow=c(2,2))
plot(dep.mod)
```

The qq-plot surely indicates a lack of normality in the residuals. 


**7.6) Search for a suitable transformation for CESD if the normality assumption in Problem 7.5 cannot be made. State why you are not able to find an ideal transformation if that is the case.**

You could try several transformations here, some are talked about in the textbook some are in the course notebook. The natural log and square root transformations are some of the more common. However... you must understand the distribution of `cesd` before you start. 

```{r}
pander(summary(dep$cesd))
```

There are zeros included. If you take a log, you will get -infinity. Taking the square root will also avoid this problem. 
```{r}
pander(summary(log(dep$cesd)))
pander(summary(sqrt(dep$cesd)))
```

An alternative approach is to add a small constant to the value before taking the log. This may be more beneficial since log transformations can still be interpreted as a % change instead of an absolute change, The square root transformation seems to do a better job of transforming the data on the low end, not as good on the high end, but then you loose interpretability. 

```{r, fig.height=4, fig.width=10}
par(mfrow=c(1,2))
qqnorm(sqrt(dep$cesd), main="sqrt(cesd)"); qqline(sqrt(dep$cesd), col="red")
qqnorm(log(dep$cesd+1), main="log(cesd+1)"); qqline(log(dep$cesd+1), col="red")
```


**7.15) Using the lung function data (a) For the oldest child, find the regression of FEV1 on 
(i) weight and age; (ii) height and age; (iii) height, weight, and age.**

```{r}
lung <- fev %>% select(ocfev1, ocweight, ocage, ocheight)

mod.i <-   lm(ocfev1 ~ ocweight + ocage, data=lung)
mod.ii <-  lm(ocfev1 ~ ocheight + ocage, data=lung)
mod.iii <- lm(ocfev1 ~ ocheight + ocweight + ocage, data=lung)
```

```{r, results='asis'}
library(stargazer)
# https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf
stargazer(mod.i, mod.ii, mod.iii)
```

<br>


**Compare the three regression equations. In each regression, which coefficients are significantly different from zero?**

* In model 1 - both weight and age are significant. 
* In model 2 - only height is significant, age is not. 
* In model 3 - weight and height are significant, but age is not. 

Height is a confounder for age, when included in the model the relationship between age and FEV1 is non-significant. You could consider age as a proxy for height.  


**(b) Find the correlation matrix for the four variables.**

```{r}
library(knitr); library(kableExtra)
kable(cor(lung), digits=2, "latex") %>% 
  kable_styling(full_width = FALSE, bootstrap_options = "striped")
```


**Which pair of variables is most highly correlated? least correlated? Heuristically, how might this explain the results of part (a)? **

Height is more highly correlated with FEV1 compared to age, and height and age are also highly correlated. There is not a lot of information that is contained in age that is not already in height. Another way to look at what is going on is by creating a scatterplot matrix. 

```{r}
library(psych)
pairs.panels(lung, hist.col="grey80", col=1, rug=FALSE, cex.cor = .5, ellipses = FALSE)
```



**7.17) Using the PARHIV data set, generate a variable that represents the sum of the variables describing the neighborhood where the adolescent lives (`NGHB1-NGHB11`). Is the age at which adolescents start smoking different for girls compared to boys, after adjusting for the score describing the neighborhood?**

```{r}
parhiv <- hiv %>% mutate(nb = rowSums(select(., contains("nghb")))) 
```

Examine the relationship before fitting the model. 
```{r, fig.align='center', fig.height=3, fig.width=6}
ggplot(parhiv, aes(x=nb, y=agesmoke, col=gender)) + 
  geom_point() + geom_smooth(se=FALSE) + theme_bw()
```

There doesn't seem to be much of a relationship between neighborhood score and the age in which an adolescent starts smoking anyhow, but it may be different between genders. Females with lower neighborhood score tend to start smoking earlier than males. For neighborhoods with score greater than 25 or so, males tend to start smoke at an earlier age. However, it is unlikely that this difference will be statistically significant, since the difference at the lower NB scores is swapped for higher scores, the difference between genders averaged across all NB scores is cancelled out. 

```{r}
nb.mod <- lm(agesmoke ~ gender + nb, data=parhiv)
pander(summary(nb.mod))
```

There are some records of kids reporting that they started smoking at ages younger than 9, or even 6. These are suspicous records. These are the types of nuances in the data that you would not notice if you don't explore the data before starting to fit models. 


```{r}
nb.mod.gt10 <- lm(agesmoke ~ gender + nb, data=subset(parhiv, agesmoke> 9))
pander(summary(nb.mod.gt10))
```

Even if we restricted the analysis data set to only incluce records for individuals who reported smoking earlier than 10 years old, there is no difference between boys or girls in which an adolescent starts smoking after controlling for neighborhood score. 

   